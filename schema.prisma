generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ─── Auth ───────────────────────────────────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String?
  image         String?
  experience    ExperienceLevel @default(BEGINNER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  cars          Car[]
  tracks        Track[]        // tracks uploaded by this user
  trackReviews  TrackReview[]
  zoneTips      ZoneTip[]
  lapRecords    LapRecord[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── Driver Profile ─────────────────────────────────────────────────────────────

enum ExperienceLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  PRO
}

model Car {
  id        String   @id @default(cuid())
  make      String
  model     String
  year      Int
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  mods       CarMod[]
  lapRecords LapRecord[]
}

model CarMod {
  id       String      @id @default(cuid())
  name     String
  category ModCategory
  notes    String?
  carId    String

  car Car @relation(fields: [carId], references: [id], onDelete: Cascade)
}

enum ModCategory {
  ENGINE
  SUSPENSION
  AERO
  BRAKES
  WHEELS_TIRES
  DRIVETRAIN
  EXHAUST
  INTERIOR
  EXTERIOR
  ELECTRONICS
  OTHER
}

// ─── Tracks ─────────────────────────────────────────────────────────────────────

model Track {
  id          String      @id @default(cuid())
  name        String
  location    String
  description String?
  imageUrl    String?     // uploaded track layout image
  status      TrackStatus @default(APPROVED)
  uploadedById String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  uploadedBy  User         @relation(fields: [uploadedById], references: [id])
  events      TrackEvent[]
  zones       TrackZone[]
  reviews     TrackReview[]
  lapRecords  LapRecord[]

  @@unique([name, location])
}

enum TrackStatus {
  PENDING
  APPROVED
  REJECTED
}

model TrackEvent {
  id        String    @id @default(cuid())
  eventType EventType
  trackId   String

  track      Track        @relation(fields: [trackId], references: [id], onDelete: Cascade)
  reviews    TrackReview[]
  lapRecords LapRecord[]

  @@unique([trackId, eventType])
}

enum EventType {
  DRIFT
  DRAG
  GRIP
}

// ─── Track Zones & Tips ─────────────────────────────────────────────────────────

model TrackZone {
  id          String  @id @default(cuid())
  name        String
  description String?
  posX        Float   // x position on track image (0-100 percentage)
  posY        Float   // y position on track image (0-100 percentage)
  trackId     String
  createdAt   DateTime @default(now())

  track Track     @relation(fields: [trackId], references: [id], onDelete: Cascade)
  tips  ZoneTip[]
}

model ZoneTip {
  id         String          @id @default(cuid())
  content    String
  conditions DrivingCondition?
  zoneId     String
  authorId   String
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  zone   TrackZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  author User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

enum DrivingCondition {
  DRY
  WET
}

// ─── Track Reviews ──────────────────────────────────────────────────────────────

model TrackReview {
  id           String           @id @default(cuid())
  rating       Int              // 1-5
  content      String?
  conditions   DrivingCondition
  trackId      String
  trackEventId String?
  authorId     String
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  track      Track      @relation(fields: [trackId], references: [id], onDelete: Cascade)
  trackEvent TrackEvent? @relation(fields: [trackEventId], references: [id])
  author     User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

// ─── Lap Records (My Lap Book) ──────────────────────────────────────────────────

model LapRecord {
  id           String           @id @default(cuid())
  lapTime      String           // stored as string for flexibility "1:23.456"
  conditions   DrivingCondition
  notes        String?

  // Tire pressures (PSI)
  tirePressureFL Float?
  tirePressureFR Float?
  tirePressureRL Float?
  tirePressureRR Float?

  // Fuel
  fuelLevel    Float?           // percentage or gallons

  // Alignment - Camber (degrees, negative = tilted in)
  camberFL     Float?
  camberFR     Float?
  camberRL     Float?
  camberRR     Float?

  // Alignment - Caster (degrees)
  casterFL     Float?
  casterFR     Float?

  // Alignment - Toe (degrees, positive = toe-in)
  toeFL        Float?
  toeFR        Float?
  toeRL        Float?
  toeRR        Float?

  // Relations
  trackId      String
  trackEventId String?
  carId        String
  driverId     String
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  track      Track      @relation(fields: [trackId], references: [id], onDelete: Cascade)
  trackEvent TrackEvent? @relation(fields: [trackEventId], references: [id])
  car        Car        @relation(fields: [carId], references: [id], onDelete: Cascade)
  driver     User       @relation(fields: [driverId], references: [id], onDelete: Cascade)
}
